<!DOCTYPE html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Vastauksesi ‚Äì Kanteliset</title>

  <link rel="icon" type="image/png" sizes="32x32" href="images/wedding.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,300,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Sacramento" rel="stylesheet">

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/style.css">

  <style>
    body { background: #faf9f7; }

    .hero {
      background-image:url(images/villavellamo.jpg);
      background-size:cover;
      background-position:center;
      padding:120px 0;
      text-align:center;
    }
    .hero .overlay {
      background:rgba(0,0,0,0.35);
      padding:40px 0;
    }
    .hero h1 {
      font-family:'Sacramento';
      font-size:48px;
      margin:0;
      color:#fff !important;
      text-shadow: 0 2px 18px rgba(0,0,0,0.45);
    }
    .hero p { color:#fff; margin-top:10px; font-size:18px; }

    .card {
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.06);
      padding:40px;
      margin-top:-80px;
      position:relative;
      z-index:2;
    }

    .section-title { font-weight:600; margin-top:30px; margin-bottom:10px; font-size:18px; }
    .line { padding:10px 0; border-bottom:1px solid rgba(0,0,0,0.05); }
    .muted { opacity:0.75; }
    .box { background:#f4f3f1; padding:16px; border-radius:12px; white-space: pre-wrap; }

    .btn-soft {
      background:#111;
      color:#fff;
      border-radius:12px;
      padding:14px 24px;
      border:none;
      display:inline-block;
      text-decoration:none;
      margin: 8px;
    }
    .btn-soft:hover { opacity:0.9; color:#fff; }

    .hidden { display:none; }
  </style>
</head>

<body>

<!-- üîù NAV -->
<nav class="fh5co-nav" role="navigation">
  <div class="container">
    <div class="row">
      <div class="col-xs-2">
        <div id="fh5co-logo">
          <a href="index.html">Kanteliset<strong>.</strong></a>
        </div>
      </div>
      <div class="col-xs-10 text-right menu-1">
        <ul>
          <li><a href="index.html">Etusivu</a></li>
          <li><a href="info.html">T√§rke√§√§</a></li>
          <li><a href="ohjelma.html">Ohjelma</a></li>
          <li><a href="tarina.html">Meid√§n tarina</a></li>
          <li><a href="gallery.html">Galleria</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<header class="hero">
  <div class="overlay">
    <h1>Vastauksenne</h1>
    <p>T√§ss√§ on tallennettu ilmoittautumisenne.</p>
  </div>
</header>

<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div class="card">

        <div style="background:#111; color:#fff; padding:18px; border-radius:12px; margin-bottom:25px; text-align:center;">
          <strong>Vastauksesi on tallennettu.</strong><br>
          Mik√§li vastauksesi muuttuu, olethan yhteydess√§ h√§√§pariin mahdollisimman pian.
        </div>

        <h3 id="familyName"></h3>

        <div id="attendanceSection"></div>

        <div id="accommodationSection" class="hidden">
          <div class="section-title">Majoitus</div>
          <div id="accommodationInfo"></div>
        </div>

        <div id="paymentSection" class="hidden">
          <div class="section-title">Maksutiedot</div>
          <div id="paymentInfoBox" class="box"></div>
          <div style="margin-top:10px;">
            Maksu Sinin ja Petrin tilille:<br>
            <strong>FI15 5722 9020 3631 79</strong>
          </div>
        </div>

        <div id="notesSection" class="hidden">
          <div class="section-title">Lis√§tiedot</div>
          <div id="notesBox" class="box"></div>
        </div>

        <div class="text-center" style="margin-top:25px;">
          <a href="kiitos.html" class="btn-soft">Takaisin</a>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
(async function () {

  const login = JSON.parse(sessionStorage.getItem("login") || "{}");
  const familyId = login.FamilyId;
  document.getElementById("familyName").innerText = login.DisplayName || "";

  const API_BASE = "https://fa-kanteliset-chdhg2g0aub8f0gy.westeurope-01.azurewebsites.net/api";
  const res = await fetch(`${API_BASE}/rsvp/${encodeURIComponent(familyId)}`);
  if (!res.ok) return;

  const rsvp = await res.json();

  function pick(obj, key) {
    const pascal = key.charAt(0).toUpperCase() + key.slice(1);
    return obj?.[key] ?? obj?.[pascal];
  }

  function renderAttendees(list) {
    if (!Array.isArray(list) || list.length === 0) return "";
    let html = `<div style="margin-top:8px; margin-left:10px;">`;
    list.forEach(a => {
      html += `<div>‚Ä¢ ${a.name || ""}`;
      if (a.diet) html += ` ‚Äì <em>${a.diet}</em>`;
      html += `</div>`;
    });
    html += `</div>`;
    return html;
  }

  const friCount = Number(pick(rsvp,"friCount")||0);
  const satCount = Number(pick(rsvp,"satCount")||0);
  const sunCount = Number(pick(rsvp,"sunCount")||0);

  let html = '<div class="section-title">Osallistuminen</div>';

  html += `<div class="line">
    Perjantai spa: <strong>${pick(rsvp,"friAttending")?"Kyll√§":"Ei"}</strong> (${friCount} hl√∂)
    ${renderAttendees(pick(rsvp,"friAttendees"))}
  </div>`;

  html += `<div class="line">
    Lauantai juhla: <strong>${pick(rsvp,"satAttending")?"Kyll√§":"Ei"}</strong> (${satCount} hl√∂)
    ${renderAttendees(pick(rsvp,"satAttendees"))}
  </div>`;

  html += `<div class="line">
    Sunnuntai brunssi: <strong>${pick(rsvp,"sunAttending")?"Kyll√§":"Ei"}</strong> (${sunCount} hl√∂)
    ${renderAttendees(pick(rsvp,"sunAttendees"))}
  </div>`;

  document.getElementById("attendanceSection").innerHTML = html;

  // üí∞ Maksuerittely korjaus
  const paymentSummary = (pick(rsvp,"paymentSummary")||"").toString();

  if (paymentSummary.trim() !== "") {

    // jos l√∂ytyy muoto "Majoitus 266 ‚Ç¨" -> muutetaan muotoon 2 √ó 133 ‚Ç¨ = 266 ‚Ç¨
    const guests = login.Guests || 0;
    const match = paymentSummary.match(/Majoitus (\d+) ‚Ç¨/);

    if (match && guests > 0) {
      const total = Number(match[1]);
      const perPerson = Math.round(total / guests);
      const newLine = `Majoitus ${guests} √ó ${perPerson} ‚Ç¨ = ${total} ‚Ç¨`;
      document.getElementById("paymentInfoBox").innerText =
        paymentSummary.replace(match[0], newLine);
    } else {
      document.getElementById("paymentInfoBox").innerText = paymentSummary;
    }

    document.getElementById("paymentSection").classList.remove("hidden");
  }

  if (pick(rsvp,"notes")) {
    document.getElementById("notesSection").classList.remove("hidden");
    document.getElementById("notesBox").innerText = pick(rsvp,"notes");
  }

})();
</script>

</body>
</html>