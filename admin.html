<!DOCTYPE html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Admin – RSVP:t</title>

  <link rel="icon" type="image/png" sizes="32x32" href="images/wedding.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/style.css">

  <style>
    body { background:#faf9f7; }
    .wrap {
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.06);
      padding: 24px;
      margin-top: 24px;
    }
    .muted { opacity:0.75; }
    .pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,0.04);
      margin-right:6px;
      font-size:13px;
    }
    table td { vertical-align: top; }
    pre { margin:0; white-space:pre-wrap; }
  </style>
</head>

<body>
<div class="container">
  <div class="wrap">
    <h2 style="margin-top:0;">Admin – RSVP:t</h2>
    <div class="muted" id="whoami"></div>

    <div style="margin:14px 0;">
      <span class="pill" id="countPill">Ladataan...</span>
      <input id="filter" class="form-control" placeholder="Hae (nimi / familyId)" style="max-width:360px; display:inline-block; margin-left:10px;">
    </div>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>FamilyId</th>
            <th>Nimi</th>
            <th>Pe (hlö)</th>
            <th>La (hlö)</th>
            <th>Su (hlö)</th>
            <th>Majoitus</th>
            <th>Maksu</th>
            <th>Lisätiedot</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="text-right" style="margin-top:10px;">
      <a class="btn btn-default" href="dashboard.html">Takaisin</a>
    </div>
  </div>
</div>

<script>
(async function () {
  const isLoggedIn = sessionStorage.getItem("isLoggedIn") === "true";
  const loginRaw = sessionStorage.getItem("login");
  if (!isLoggedIn || !loginRaw) { window.location.replace("index.html"); return; }

  const login = JSON.parse(loginRaw);
  if (String(login.Role || "").toLowerCase() !== "admin") {
    alert("Ei oikeuksia admin-näkymään.");
    window.location.replace("index.html");
    return;
  }

  document.getElementById("whoami").innerText = `Kirjautunut: ${login.DisplayName} (admin)`;

  const API_BASE = "https://fa-kanteliset-chdhg2g0aub8f0gy.westeurope-01.azurewebsites.net/api";

  const res = await fetch(`${API_BASE}/admin/rsvps`);
  if (!res.ok) { alert("Admin RSVP -haku epäonnistui."); return; }

  const data = await res.json(); // [{ familyId, updatedUtc, payload }]
  document.getElementById("countPill").innerText = `Vastauksia: ${data.length}`;

  const tbody = document.getElementById("rows");

  function render(list) {
    tbody.innerHTML = "";

    for (const item of list) {
      const p = item.payload || {};
      const tr = document.createElement("tr");

      const payment = (p.PaymentSummary || "").toString();
      const notes = (p.Notes || "").toString();

      tr.innerHTML = `
        <td><strong>${item.FamilyId || item.familyId || ""}</strong><div class="muted">${item.UpdatedUtc || item.updatedUtc || ""}</div></td>
        <td>${p.DisplayName || ""}</td>
        <td>${p.FriAttending ? "Kyllä" : "Ei"}<div class="muted">${p.FriCount || 0} hlö</div></td>
        <td>${p.SatAttending ? "Kyllä" : "Ei"}<div class="muted">${p.SatCount || 0} hlö</div></td>
        <td>${p.SunAttending ? "Kyllä" : "Ei"}<div class="muted">${p.SunCount || 0} hlö</div></td>
        <td>${p.Accommodation ? "Kyllä" : "Ei"}</td>
        <td><pre>${payment}</pre></td>
        <td><pre>${notes}</pre></td>
      `;

      tbody.appendChild(tr);
    }
  }

  render(data);

  document.getElementById("filter").addEventListener("input", (e) => {
    const q = (e.target.value || "").toLowerCase().trim();
    if (!q) { render(data); return; }

    const filtered = data.filter(x => {
      const fid = (x.FamilyId || x.familyId || "").toLowerCase();
      const name = ((x.payload && x.payload.DisplayName) ? x.payload.DisplayName : "").toLowerCase();
      return fid.includes(q) || name.includes(q);
    });

    render(filtered);
  });

})();
</script>

</body>
</html>